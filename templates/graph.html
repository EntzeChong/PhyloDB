{% extends 'base.html' %}

{% block jquery %}
    <!-- dynatree -->
    <link rel='stylesheet' type='text/css' href="../media/dynatree/ui.dynatree.css">
    <script src="../media/dynatree/jquery.dynatree.js" type="text/javascript"></script>
{% endblock %}

{% block pagetitle %}
    <title>Graph</title>
{% endblock %}

{% block dynatree %}
    <script type="text/javascript">

        $(function () {

            $("#tree_meta").dynatree({
                checkbox: true,
                selectMode: 3,
                initAjax: {
                    url: '/getSampleTree/',
                    dataType: 'jsonp',
                    data: {}
                },
                onSelect: function () {
                    var selectedNodes = $("#tree_meta").dynatree("getSelectedNodes");
                    selectedKeys = $.map(selectedNodes, function (node) {
                        return node.data.id;
                    });

                    drawChart();
                }
            }); // end tree

            $("#tree_taxa").dynatree({
                checkbox: true,
                selectMode: 2,
                initAjax: {
                    url: '/getTaxaTree/',
                    dataType: 'jsonp',
                    data: {}
                },
                onSelect: function () {
                    var selectedNodes = $("#tree_taxa").dynatree("getSelectedNodes");
                    selectedKeys = $.map(selectedNodes, function (node) {
                        return node.data.id;
                    });

                    //requery and get counts --- not functional
                    $.ajax({
                        type: 'post',
                        async: false,
                        url: "/requery/",
                        data: selectedKeys.serialize()
                        });

                    //drawchart
                    drawChart();
                }
            }); // end
        });

        // Load the Visualization API and the piechart package.
        google.load('visualization', '1.0', {'packages':['corechart']});

        // Set a callback to run when the Google Visualization API is loaded.
        google.setOnLoadCallback(drawChart);

        // Callback that creates and populates a data table,
        // instantiates the pie chart, passes in the data and
        // draws it.
        function drawChart() {

            var sampleNodes = $("#tree_meta").dynatree("getSelectedNodes");
            sampleNames = $.map(sampleNodes,function (node) {
                return node.data.title;
            });

            var taxaNodes = $("#tree_taxa").dynatree("getSelectedNodes");
            taxaNames = $.map(sampleNodes,function (node) {
                return node.data.title;
            });
            taxaIDs = $.map(sampleNodes,function (node) {
                return node.data.id;
            });

            var fc = sampleNames.length;
            var sc = taxaNames.length;
            var counts = new  Array();

            for (var i = 0; i < fc; i++)
            {
                //Sample
                for (var j = 0; j < sc; j++) {
                    //Data
                    counts.push(j + 1);
                }
            }

            // Create the data table.
            var data = new google.visualization.DataTable();
            var seq = 0;
            data.addColumn('string', 'Category');
            data.addColumn('number', 'Count');
            for (var c = 0; c < fc; c++) {
                for (var d = 0; d < sc; d++) {
                    data.addRows([
                        [(first[c].toString() + " - " + second[d].toString()), counts[seq]]
                    ]);
                    seq++;
                }
            }

            // Set chart options
            var options = {'title': first.toString() + " and " +second.toString(),
                'width': 400,
                'height': 300};

            // Instantiate and draw our chart, passing in some options.
            var chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
            chart.draw(data, options);
        }
    </script>
{% endblock %}

{% block content %}
    <form>
        <br>
        <!-- tree tables -->
        <table width="100%" border="2" cellspacing="0" cellpadding="5">
            <th>Select categorical variables</th>
            <th>Select taxa level</th>
            <tr>
                <td width="50%" style="padding-right: 10px; vertical-align: top">

                    <!-- left tree -->
                    <table id="tbl_meta" width="100%" border="0" cellspacing="0" cellpadding="1">
                        <tr>
                            <td>
                                <div id="tree_meta"></div>
                            </td>
                        </tr>
                    </table>
                </td>
                <td width="50%" style="padding-right: 10px; vertical-align: top">
                    <!-- right table -->
                    <table id="tbl_taxa" width="100%" border="0" cellspacing="0" cellpadding="1">
                        <tr>
                            <td>
                                <div id="tree_taxa"></div>
                            </td>
                        </tr>
                    </table>
                    <!-- end of main table -->
                </td>
            </tr>
        </table>
        <br>
        <p>Things to work on...<br>
        </p>
        <br>

        <!-- graph table -->
        <table id="graph" border="2">
            <th style="padding-right: 10px;">Title should reflect selections</th>
            <tr>
                <td style="vertical-align: top">
                    <p>insert graph here</p>
                    <div id="chart_div"></div>
                </td>
            </tr>
        </table>
        <p> TO DO:<br>
        Graph:<br>
        1. Y-axis = abundance<br>
        2. X-axis = categorical variables (quantitative could be added without children?)<br>
        3. Series = selected taxa<br>
        4. Categorical = Bar chart; Quantitative = Scatter plot<br>
        </p>
        <h3>Get selected data:<input type="button" value="Go!"/></h3>
        <h3>Run ANOVA using above selections:<input type="button" value="Run!"/></h3>
    </form>
{% endblock %}
