{% extends 'base.html' %}

{% block pagetitle %}
    <title>Graph</title>
{% endblock %}

{% block javascript %}
    <script type="text/javascript">

        $(function () {
            $("button").click(function () {
                $("toggle").toggle();
            });

            $("#tree_metaCat").dynatree({
                checkbox: true,
                selectMode: 3,
                initAjax: {
                    url: '/getSampleCatTree/',
                    dataType: 'jsonp',
                    data: {}
                },
                onSelect: function () {
                    chooseData();
                },
                onPostInit: function () {
                    chooseData()
                }
            }); // end tree

            $("#tree_metaQuant").dynatree({
                checkbox: true,
                selectMode: 1,
                initAjax: {
                    url: '/getSampleQuantTree/',
                    dataType: 'jsonp',
                    data: {}
                },
                onSelect: function () {
                    chooseData();
                },
                onPostInit: function () {
                    chooseData()
                }
            }); // end tree

            $("#tree_taxa").dynatree({
                checkbox: true,
                selectMode: 2,
                initAjax: {
                    url: '/getTaxaTree/',
                    dataType: 'jsonp',
                    data: {}
                },
                onSelect: function () {
                   chooseData();
                }
            }); // end tree

        }); // end function

        function chooseData() {
            var nodesCat = $("#tree_metaCat").dynatree("getSelectedNodes");
            var nodesQuant = $("#tree_metaQuant").dynatree("getSelectedNodes");
            var nodesTaxa = $("#tree_taxa").dynatree("getSelectedNodes");
            if ((nodesCat != "") && (nodesTaxa != "")) {
                getCatData();
            }
            if ((nodesQuant != "") && (nodesTaxa != "")) {
                getQuantData();
            }
        }

        function getCatData() {
            var myDict = {};
            myDict['meta'] = getCatMetaValues();
            myDict['taxa'] = getTaxaValues();
            jsonDict = JSON.stringify(myDict);

            $.ajax({
                url: '/getCatGraphData/',
                type: 'GET',
                dataType: 'json',
                data: {
                    all: jsonDict
                },
                success: function(data) {
                    var result = JSON.stringify(data);
                    var obj = $.parseJSON(result);
                    nvd3BarChart(obj);
                }
            });
        }

        function getQuantData() {
            var myDict = {};
            myDict['meta'] = getQuantMetaValues();
            myDict['taxa'] = getTaxaValues();
            jsonDict = JSON.stringify(myDict);

            $.ajax({
                url: '/getQuantGraphData/',
                type: 'GET',
                dataType: 'json',
                data: {
                    all: jsonDict
                },
                success: function(data) {
                    var result = JSON.stringify(data);
                    var obj = $.parseJSON(result);
                    nvd3LineChart(obj);
                    nvd3ScatterChart(obj);
                }
            });
        }

        function getCatMetaValues() {
            var string = "";
            var nodes = $("#tree_metaCat").dynatree("getSelectedNodes");
            for (i in nodes) {
                var value = nodes[i].data.title;
                var parent = nodes[i].getParent();
                var key = parent.data.title;
                if (nodes[i].getLevel() == 4) {
                    string = key + "//" + value + "|" + string;
                }
            }
            return string.substring(0, string.length - 1);
        }

        function getQuantMetaValues() {
            var string = "";
            var nodes = $("#tree_metaQuant").dynatree("getSelectedNodes");
            for (i in nodes) {
                var value = nodes[i].data.title;
                var parent = nodes[i].getParent();
                var key = parent.data.title;
                if (nodes[i].getLevel() == 3) {
                    string = key + "//" + value + "|" + string;
                }
            }
            return string.substring(0, string.length - 1);
        }

        function getTaxaValues() {
            var string = "";
            var nodes = $("#tree_taxa").dynatree("getSelectedNodes");
            for (i in nodes) {
                var value = nodes[i].data.id;
                if (nodes[i].getLevel() >= 3) {
                    string = value + "|" + string;
                }
            }
            return string.substring(0, string.length - 1);
        }

        function nvd3BarChart(obj) {
<<<<<<< HEAD
             if (document.getElementById("abun").checked) {
=======
            if (document.getElementById("abun").checked)
            {
>>>>>>> origin/master
                nv.addGraph(function () {
                var chart = nv.models.multiBarChart()
                                .x(function(d) {return d.label})
                                .y(function(d) {return d.ave_rel_abund})
<<<<<<< HEAD
                                .reduceXTicks(false)
                                .rotateLabels(45)
                                .showControls(true)
                                .groupSpacing(0.1)
                        ;

                chart.yAxis
                        .tickFormat(d3.format(',.2e'));

                d3.select('#barchart svg')
                        .datum(obj)
                        .transition().duration(500)
=======
                                .transitionDuration(50)
                                .reduceXTicks(false)   //If 'false', every single x-axis tick label will be rendered.
                                .rotateLabels(-900)      //Angle to rotate x-axis labels.
                                .showControls(true)   //Allow user to switch between 'Grouped' and 'Stacked' mode.
                                .groupSpacing(0.1)    //Distance between each group of bars.
                        ;

                //chart.xAxis
                //        .tickFormat(d3.format(',f'));

                chart.yAxis
                        .tickFormat(d3.format(',.2f'));

                d3.select('#barchart svg')
                        .datum(obj)
                        .transition().duration(1)
>>>>>>> origin/master
                        .call(chart);

                nv.utils.windowResize(chart.update);

                return chart;
                });
<<<<<<< HEAD
             }
             if (document.getElementById("rich").checked) {
=======
            }
            if (document.getElementById("rich").checked)
            {
>>>>>>> origin/master
                nv.addGraph(function () {
                var chart = nv.models.multiBarChart()
                                .x(function(d) {return d.label})
                                .y(function(d) {return d.ave_rich})
<<<<<<< HEAD
                                .reduceXTicks(false)
                                .rotateLabels(45)
                                .showControls(true)
                                .groupSpacing(0.1)
                        ;

                chart.yAxis
                        .tickFormat(d3.format(',.1f'));

                d3.select('#barchart svg')
                        .datum(obj)
                        .transition().duration(500)
=======
                                .transitionDuration(50)
                                .reduceXTicks(false)   //If 'false', every single x-axis tick label will be rendered.
                                .rotateLabels(-900)      //Angle to rotate x-axis labels.
                                .showControls(true)   //Allow user to switch between 'Grouped' and 'Stacked' mode.
                                .groupSpacing(0.1)    //Distance between each group of bars.
                        ;

                //chart.xAxis
                //        .tickFormat(d3.format(',f'));

                chart.yAxis
                        .tickFormat(d3.format(',.2f'));

                d3.select('#barchart svg')
                        .datum(obj)
                        .transition().duration(1)
>>>>>>> origin/master
                        .call(chart);

                nv.utils.windowResize(chart.update);

                return chart;
                });
<<<<<<< HEAD
             }
        }

         function mySort(data)//Used below to make the graph readable
            {
                for (var counter = 0; counter<data.length; counter++)//data.length should be number of taxa selected
                {
                var d=0;
                var dataOrder = [];
                while (d<data[counter]['values'].length) {
                    //alert("There are "+data[0]['values'].length +" elements in this list");
                    var c = 0;
                    var shortestval = 1000;
                    var shortestid = -1;
                    while (c < data[counter]['values'].length) {
=======
            }
         }


        function mySort(data)//Used below to make the graph readable
        {
            for (var counter = 0; counter<data.length; counter++)//data.length should be number of taxa selected
            {
            var d=0;
            var dataOrder = [];
            while (d<data[counter]['values'].length) {
                //alert("There are "+data[0]['values'].length +" elements in this list");
                var c = 0;
                var shortestval = 1000;
                var shortestid = -1;
                while (c < data[counter]['values'].length) {
>>>>>>> origin/master
                    //Check that this C is not in the list already
                    if (dataOrder.indexOf(c)!=-1)
                    {
                        //Already in the list
                    }
                    else
                    {
                        if (parseInt(data[counter]['values'][c]['x'],10) < shortestval)
                        {
                            shortestval = data[counter]['values'][c]['x'];
                            shortestid = c;
                        }
                    }
                    c++;
                }
                dataOrder.push(shortestid);
                d++;
            }
<<<<<<< HEAD
            //var listString = "";DEBUG STRING
            var newDataX = [];
            var newDataY = [];
=======
                //var listString = "";DEBUG STRING
                var newDataX = [];
                var newDataY = [];
>>>>>>> origin/master
            for (var cou=0;cou<dataOrder.length;cou++)
            {
                newDataX.push(data[counter]['values'][dataOrder[cou]]['x']);
                newDataY.push(data[counter]['values'][dataOrder[cou]]['y']);
                //listString = listString+data[counter]['values'][dataOrder[cou]]['x']+", ";
            }
<<<<<<< HEAD
            //alert(listString);
=======
                //alert(listString);
>>>>>>> origin/master
            for (cou=0;cou<dataOrder.length;cou++)
            {
                data[counter]['values'][cou]['x']=newDataX[cou];
                data[counter]['values'][cou]['y']=newDataY[cou];
            }
            }
        }

<<<<<<< HEAD
        function nvd3LineChart(obj) {
            if (document.getElementById("abun").checked) {
                nv.addGraph(function () {
                    var chart = nv.models.scatterChart()
                                .x(function(d) {return d.x})
                                .y(function(d) {return d.y_abund})
                            ;

           // mySort(obj);

           chart.yAxis
                    .tickFormat(d3.format(',.2e'));
=======

        function nvd3LineChart(obj) {
            nv.addGraph(function () {
            if (document.getElementById("abun").checked)
            var chart = nv.models.lineChart().y(function (d) {return d.abund});
            if (document.getElementById("rich").checked)
            var chart = nv.models.lineChart().y(function (d) {return d.rich});

                mySort(obj);
>>>>>>> origin/master

            d3.select('#linechart svg')
                    .datum(obj)
                    .transition().duration(50)
                    .call(chart);

            nv.utils.windowResize(chart.update);

            return chart;
            });
        }

<<<<<<< HEAD
        if (document.getElementById("rich").checked) {
                nv.addGraph(function () {
                    var chart = nv.models.scatterChart()
                                .x(function(d) {return d.x})
                                .y(function(d) {return d.y_rich})
                            ;

           // mySort(obj);

           chart.yAxis
                    .tickFormat(d3.format(',.1f'));
=======
        function nvd3ScatterChart(obj) {
            nv.addGraph(function () {
                if (document.getElementById("rich").checked)
                {
                    var chart = nv.models.scatterChart().y(function (d) {return d.rich});
                }
                if (document.getElementById("abun").checked)
                {
                    var chart = nv.models.scatterChart().y(function (d) {return d.abund});
                }

>>>>>>> origin/master

            d3.select('#linechart svg')
                    .datum(obj)
                    .transition().duration(50)
                    .call(chart);

            nv.utils.windowResize(chart.update);

            return chart;
            });
        }
    }


    </script>
{% endblock javascript %}

{% block my_content %}
    <br>
    <p>Use button to change between Categorical and Quantitative variables</p>
    <button>Toggle</button>
    <toggle><h2>Categorical Data Selected</h2></toggle>
    <toggle style="display: none"><h2>Quantitative Data Selected</h2></toggle>
    <form>
        <!-- tree tables -->
        <table border="2" cellspacing="0" cellpadding="5">
            <tr>
                <th>Select Meta Data<br>
                </th>
                <th>Select Taxa level</th>
            </tr>
            <tr>
                <td style="padding-right: 10px; vertical-align: top">
                    <!-- left tree -->
                    <table border="0" cellspacing="0" cellpadding="1">
                        <tr>
                            <td>
                                <toggle>
                                    <div id="tree_metaCat"></div>
                                </toggle>
                                <toggle style="display: none">
                                    <div id="tree_metaQuant"></div>
                                </toggle>
                            </td>
                        </tr>
                    </table>
                </td>
                <td style="padding-right: 10px; vertical-align: top">
                    <!-- right table -->
                    <table border="0" cellspacing="0" cellpadding="1">
                        <tr>
                            <td>
                                <div id="tree_taxa"></div>
                            </td>
                        </tr>
                    </table>
                    <!-- end of main table -->
                </td>
            </tr>
        </table>
        Dependent variable:
        <form action="">
<<<<<<< HEAD
            <input type="radio" id="abun" name="DATABUTTON" onclick="chooseData()" checked="checked">Relative Abundance
            <input type="radio" id="rich" name="DATABUTTON" onclick="chooseData()">Richness
=======
        <input type="radio" id="abun" name="DATABUTTON" onclick="chooseData()" checked="checked">Relative Abundance
        <input type="radio" id="rich" name="DATABUTTON" onclick="chooseData()">Richness
>>>>>>> origin/master
        </form>
        <br>
        <br>

        <!-- graph table -->
        <table width="150%" border="2">
<<<<<<< HEAD
        <tr>
            <th style="padding-right: 10px;">GraphData</th>
        </tr>
        <tr>
            <td width="150%" style="vertical-align: top">
                <toggle>
                    <h2>Bar Chart</h2>
                    <div id="barchart">  <svg style="height: 500px"></svg> </div>
                </toggle>
                <toggle style="display: none">
                    <h2>Scatter Plot</h2>
                    <div id="linechart">  <svg style="height: 500px"></svg> </div>
                </toggle>
            </td>
        </tr>
=======
            <tr>
                <th style="padding-right: 10px;">Graph Data</th>
            </tr>
            <tr>
                <td width="150%" style="vertical-align: top">
                    <toggle>
                        <div id="barchart">  <svg style="height: 500px"></svg> </div>
                    </toggle>
                    <toggle style="display: none">
                        <div id="linechart">  <svg style="height: 500px"></svg> </div>
                    </toggle>
                </td>
            </tr>
>>>>>>> origin/master
        </table>

        <p> TO DO:<br>
        1. Add button to switch to richness
        2. Add data table
        </p>

        <h3>Get selected data:<input type="button" value="Go!"/></h3>
        <h3>Run ANOVA using above selections:<input type="button" value="Run!"/></h3>
    </form>

{% endblock my_content%}
