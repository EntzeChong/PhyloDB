{% extends 'base.html' %}

{% block jquery %}
    <!-- dynatree -->
    <link rel='stylesheet' type='text/css' href="../media/dynatree/ui.dynatree.css">
    <script src="../media/dynatree/jquery.dynatree.js" type="text/javascript"></script>

    <!-- nvd3 stuff -->
    <script src="/media/nvd3/nvd3.lib/d3.v2.js"></script>
    <script src="/media/nvd3/nv.d3.js"></script>
    <script src="/media/nvd3/nvd3.src/tooltip.js"></script>
    <script src="/media/nvd3/nvd3.src/utils.js"></script>
    <script src="/media/nvd3/nvd3.src/models/legend.js"></script>
    <script src="/media/nvd3/nvd3.src/models/axis.js"></script>
    <script src="/media/nvd3/nvd3.src/models/scatter.js"></script>
    <script src="/media/nvd3/nvd3.src/models/line.js"></script>
    <link href="/media/nvd3/nvd3.src/nv.d3.css" rel="stylesheet" type="text/css">

{% endblock %}

{% block pagetitle %}
    <title>Graph</title>
{% endblock %}

{% block dynatree %}
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">

        $(function () {

            $("#tree_meta").dynatree({
                checkbox: true,
                selectMode: 3,
                initAjax: {
                    url: '/getSampleCatTree/',
                    dataType: 'jsonp',
                    data: {}
                },
                onSelect: function (node) {
                    getData(node);
                    //updateDataTable();
                }
        }); // end tree

            $("#tree_taxa").dynatree({
                checkbox: true,
                selectMode: 2,
                initAjax: {
                    url: '/getTaxaTree/',
                    dataType: 'jsonp',
                    data: {}
                },
                onSelect: function (node) {
                    getData(node);
                    //updateDataTable();
                }
            }); // end tree
        }); // end function

        function getMetaValues() {
            var string = "";
            var nodes = $("#tree_meta").dynatree("getSelectedNodes");
            for (i in nodes) {
                var value = nodes[i].data.title;
                var parent = nodes[i].getParent();
                var key = parent.data.title;
                if (nodes[i].getLevel() == 4) {
                    string = key + "//" + value + "|" + string;
                }
            }
            return string.substring(0, string.length - 1);
        }

        function getTaxaValues() {
            var string = "";
            var nodes = $("#tree_taxa").dynatree("getSelectedNodes");
            for (i in nodes) {
                var value = nodes[i].data.id;
                var key = nodes[i].data.tooltip;
                string = key + "//" + value  + "|" + string;
            }
            return string.substring(0, string.length - 1);
        }

        function getData() {
            var myDict = {};
            myDict['meta'] = getMetaValues();
            myDict['taxa'] = getTaxaValues();
            jsonDict = JSON.stringify(myDict);

            $.ajax({
                url: '/getCatGraphData/',
                type: 'GET',
                dataType: 'json',
                data: {
                    all: jsonDict
                },
                success: function(data) {
                    var result = JSON.stringify(data);
                    var obj = $.parseJSON(result);
                    nvd3Chart(obj);
                } // end success
            }); // end Ajax
        } // end getData()

        function nvd3Chart(obj) {
            nv.addGraph(function () {
                var chart = nv.models.multiBarChart()
                        .x(function(d) {return d.label})
                        .y(function(d) {return d.ave_rel_abund})
                        .transitionDuration(350)
                        .reduceXTicks(true)   //If 'false', every single x-axis tick label will be rendered.
                        .rotateLabels(90)      //Angle to rotate x-axis labels.
                        .showControls(true)   //Allow user to switch between 'Grouped' and 'Stacked' mode.
                        .groupSpacing(0.1)    //Distance between each group of bars.
                        ;

                //chart.xAxis
                //        .tickFormat(d3.format(',f'));

                chart.yAxis
                        .tickFormat(d3.format(',.2f'));

                d3.select('#chart svg')
                    .datum(obj)
                    .transition().duration(500)
                    .call(chart);

                nv.utils.windowResize(chart.update);

                return chart;
            });
        }
    </script>
{% endblock %}

{% block content %}
    <form>
        <br>
        <!-- tree tables -->
        <table width="100%" border="2" cellspacing="0" cellpadding="5">
            <tr>
                <th>Select Meta Data</th>
                <th>Select Taxa level</th>
            </tr>
            <tr>
                <td width="50%" style="padding-right: 10px; vertical-align: top">

                    <!-- left tree -->
                    <table id="tbl_meta" width="100%" border="0" cellspacing="0" cellpadding="1">
                        <tr>
                            <td>
                                <div id="tree_meta"></div>
                            </td>
                        </tr>
                    </table>
                </td>
                <td width="50%" style="padding-right: 10px; vertical-align: top">
                    <!-- right table -->
                    <table id="tbl_taxa" width="100%" border="0" cellspacing="0" cellpadding="1">
                        <tr>
                            <td>
                                <div id="tree_taxa"></div>
                            </td>
                        </tr>
                    </table>
                    <!-- end of main table -->
                </td>
            </tr>
        </table>
        <br>
        <br>

        <!-- graph table -->
        <table width="100%" border="2">
            <tr>
                <th style="padding-right: 10px;">Graph Data</th>
            </tr>
            <tr>
                <td width="100%" style="vertical-align: top">
                    <div id="chart">
                        <svg style="height: 500px"></svg>
                    </div>
                </td>
            </tr>
        </table>
        <p> TO DO:<br>
        Graph:<br>
        1. Y-axis = abundance<br>
        2. X-axis = categorical variables (quantitative could be added without children?)<br>
        3. Series = selected taxa<br>
        4. Categorical = Bar chart; Quantitative = Scatter plot<br>
        </p>
        <h3>Get selected data:<input type="button" value="Go!"/></h3>
        <h3>Run ANOVA using above selections:<input type="button" value="Run!"/></h3>
    </form>
{% endblock %}
